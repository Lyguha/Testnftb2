local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local auto = 0
local autoFarmEnabled = false
local currentMoney = 0

-- Получаем ссылки на необходимые объекты игры
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Оптимизированные переменные для быстрого доступа
local Events = ReplicatedStorage:WaitForChild("Events")
local OpenCaseEvent = Events:WaitForChild("OpenCase")
local InventoryEvent = Events:WaitForChild("Inventory")

-- Функция для получения текущего количества денег из игры
local function getMoney()
    local success, result = pcall(function()
        local starsValue = LocalPlayer:WaitForChild("_StarsValue")
        return starsValue.Value
    end)
    
    if success then
        return result
    else
        warn("Ошибка при получении денег: " .. tostring(result))
        return currentMoney
    end
end

-- Функция для определения, какой кейс открывать
local function getCaseToOpen()
    local money = getMoney()
    if money >= 5500000 then
        return "Bloody Night"
    elseif money >= 21000 then
        return "Gold"
    else
        return "Trash"
    end
end

-- УЛУЧШЕННАЯ ФУНКЦИЯ ОТКРЫТИЯ КЕЙСОВ С ОБХОДОМ ЗАДЕРЖЕК
local function fastOpenCase(caseType, amount)
    local success, errorMsg = pcall(function()
        -- Способ 1: Быстрое последовательное открытие
        for i = 1, amount do
            local args = {caseType, 1}
            OpenCaseEvent:InvokeServer(unpack(args))
            
            -- Минимальная задержка вместо стандартной
            if i % 5 == 0 then
                task.wait(0.01) -- Короткая пауза каждые 5 кейсов
            end
        end
        
        return true
    end)
    
    if not success then
        -- Способ 2: Пакетное открытие (если поддерживается игрой)
        local success2 = pcall(function()
            local args = {caseType, amount}
            OpenCaseEvent:InvokeServer(unpack(args))
            return true
        end)
        
        if success2 then
            return true
        else
            warn("Ошибка при открытии кейсов: " .. tostring(errorMsg))
            return false
        end
    end
    
    return success
end

-- ОПТИМИЗИРОВАННАЯ ФУНКЦИЯ ПРОДАЖИ
local function fastSellAll()
    local success, errorMsg = pcall(function()
        local args = {"Sell", "ALL"}
        InventoryEvent:FireServer(unpack(args))
        return true
    end)
    
    if not success then
        warn("Ошибка при продаже: " .. tostring(errorMsg))
        return false
    end
    return true
end

-- УЛУЧШЕННАЯ ФУНКЦИЯ АВТОФАРМА С ОБХОДОМ ЗАДЕРЖЕК
local function optimizedAutoFarm()
    while autoFarmEnabled do
        local caseType = getCaseToOpen()
        
        -- Открываем кейсы с оптимизацией
        local openSuccess = fastOpenCase(caseType, 10)
        
        if openSuccess then
            -- Быстрая продажа сразу после открытия
            fastSellAll()
            
            -- Обновляем счетчики
            auto += 10
            currentMoney = getMoney()
            
            -- Минимальная задержка между циклами
            task.wait(0.1)
        else
            -- Если ошибка, ждем немного больше
            task.wait(1)
        end
    end
end

-- Функция для сверхбыстрого фарма (экспериментальная)
local function ultraFastFarm()
    while autoFarmEnabled do
        local caseType = getCaseToOpen()
        local money = getMoney()
        
        -- Определяем количество кейсов которое можем открыть
        local caseCost = 0
        if caseType == "Trash" then caseCost = 100
        elseif caseType == "Gold" then caseCost = 3000
        elseif caseType == "Bloody Night" then caseCost = 5500000 end
        
        local maxCases = math.floor(money / caseCost)
        local casesToOpen = math.min(maxCases, 50) -- Ограничиваем чтобы не крашнуть
        
        if casesToOpen > 0 then
            -- Пытаемся открыть все кейсы сразу
            local success = pcall(function()
                local args = {caseType, casesToOpen}
                OpenCaseEvent:InvokeServer(unpack(args))
            end)
            
            if success then
                -- Немедленная продажа
                fastSellAll()
                auto += casesToOpen
            end
        end
        
        currentMoney = getMoney()
        task.wait(0.05) -- Очень короткая задержка
    end
end

-- Создание окна (ваш существующий код)
local Window = Rayfield:CreateWindow({
   Name = "Автофарм кейсов",
   Icon = 0,
   LoadingTitle = "не мой гуи",
   LoadingSubtitle = "by Sirius",
   ShowText = "Автофарм Trash кейсов",
   Theme = "Default",
   ToggleUIKeybind = "K",
   DisableRayfieldPrompts = false,
   DisableBuildWarnings = false,
   ConfigurationSaving = {
      Enabled = false,
      FolderName = nil,
      FileName = "Big Hub"
   },
   Discord = {
      Enabled = false,
      Invite = "noinvitelink",
      RememberJoins = true
   },
   KeySystem = false
})

-- Создание вкладок (ваш существующий код)
local Tab8 = Window:CreateTab("Авто Фарм", "settings")
-- ... остальные вкладки

-- ДОБАВЛЕННЫЕ ФУНКЦИИ ДЛЯ ОБХОДА ЗАДЕРЖЕК:

local ultraFastMode = false

-- Тоггл для ультра-быстрого режима
local UltraToggle = Tab8:CreateToggle({
    Name = "УЛЬТРА-БЫСТРЫЙ РЕЖИМ (риск бана)",
    CurrentValue = false,
    Flag = "UltraFastToggle",
    Callback = function(Value)
        ultraFastMode = Value
        if Value then
            Rayfield:Notify({
                Title = "Включен ультра-режим",
                Content = "Максимальная скорость фарма",
                Duration = 3,
                Image = "⚡",
            })
        end
    end,
})

-- Кнопка для мгновенного открытия множества кейсов
local Button = Tab8:CreateButton({
    Name = "Мгновенно открыть 50 кейсов",
    Callback = function()
        local caseType = getCaseToOpen()
        local success = fastOpenCase(caseType, 50)
        if success then
            Rayfield:Notify({
                Title = "Успешно",
                Content = "Открыто 50 " .. caseType .. " кейсов",
                Duration = 3,
                Image = "✓",
            })
        end
    end,
})

-- Обновленная функция автофарма
local function autoFarmCases()
    if ultraFastMode then
        ultraFastFarm()
    else
        optimizedAutoFarm()
    end
end

-- Обновленный тоггл автофарма
local ToggleButton = Tab8:CreateToggle({
    Name = "Авто Фарм кейсов",
    CurrentValue = false,
    Flag = "AutoFarmToggle",
    Callback = function(Value)
        autoFarmEnabled = Value
        if Value then
            Rayfield:Notify({
                Title = "Автофарм запущен",
                Content = ultraFastMode and "УЛЬТРА-РЕЖИМ" or "Стандартный режим",
                Duration = 3,
                Image = "✓",
            })
            coroutine.wrap(autoFarmCases)()
        else
            Rayfield:Notify({
                Title = "Автофарм остановлен",
                Content = "Автоматический фарм отключен",
                Duration = 3,
                Image = "✗",
            })
        end
    end,
})

-- Остальной ваш код...
